<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trades ‚Ä¢ Trade Consolidator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
    <div class="layout">
        <aside id="sidebar" class="sidebar"></aside>
        <main class="main">
        <div class="app-container">
            <div class="app-header sticky-header" style="align-items: center; gap: 12px; justify-content: space-between;">
                <h1 style="margin:0;">Trades</h1>
                <div class="filter-inline">
                    <div class="filter-item">
                        <label>Conta</label>
                        <select id="accountFilter" onchange="filterTrades()">
                            <option value="">Todas as contas</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>Estrat√©gia</label>
                        <select id="strategyFilter" onchange="filterTrades()">
                            <option value="">Todas as estrat√©gias</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>Instrumento</label>
                        <select id="instrumentFilter" onchange="filterTrades()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filter-item dropdown">
                        <button class="btn btn-secondary small" onclick="toggleDatePanel(event)">Data</button>
                        <div id="datePanel" class="dropdown-panel">
                            <div class="preset-buttons">
                                <button class="btn" onclick="setPreset('this_week')">Essa semana</button>
                                <button class="btn" onclick="setPreset('last_week')">Semana passada</button>
                                <button class="btn" onclick="setPreset('this_month')">Esse m√™s</button>
                                <button class="btn" onclick="setPreset('last_month')">M√™s passado</button>
                                <button class="btn" onclick="setPreset('this_year')">Esse ano</button>
                                <button class="btn" onclick="setPreset('last_year')">Ano passado</button>
                            </div>
                            <input type="text" id="dateRangeInput" class="flatpickr-input" placeholder="Intervalo personalizado">
                            <input type="hidden" id="datePreset">
                            <input type="hidden" id="dateFrom">
                            <input type="hidden" id="dateTo">
                        </div>
                    </div>
                    <div class="filter-item">
                        <button class="btn btn-secondary small" onclick="clearFilters()">Limpar</button>
                    </div>
                </div>
                <button class="btn btn-danger" onclick="deleteAllTransactions()">üóëÔ∏è Excluir Tudo</button>
            </div>
        <div id="tradeDetails" class="sticky-details" style="display:none; margin-top:20px; background: var(--card-bg); padding: 20px; border-radius: 8px; border-left: 5px solid var(--primary);">
            <div class="detail-header" style="display:flex; justify-content: space-between; align-items:center; margin-bottom:20px;">
                <h2>üìä Detalhes do Trade</h2>
                <button class="close-btn" onclick="closeTradeDetails()">‚úï Fechar</button>
            </div>
            <div class="detail-grid" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:15px; margin:20px 0;">
                <div class="detail-item" style="background: var(--card-bg); padding:15px; border-radius:4px;">
                    <strong>Instrumento</strong>
                    <span id="detailInstrument">-</span>
                </div>
                <div class="detail-item" style="background: var(--card-bg); padding:15px; border-radius:4px;">
                    <strong>Tipo</strong>
                    <span id="detailType">-</span>
                </div>
                <div class="detail-item" style="background: var(--card-bg); padding:15px; border-radius:4px;">
                    <strong>Status</strong>
                    <span id="detailStatus">-</span>
                </div>
                <div class="detail-item" style="background: var(--card-bg); padding:15px; border-radius:4px;">
                    <strong>Conta</strong>
                    <span id="detailAccount">-</span>
                </div>
            </div>
            <div style="margin-top: 10px; padding: 20px; background: var(--card-bg); border-radius: 4px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                <div style="border-left: 4px solid var(--primary); padding-left: 15px;">
                    <strong style="display: block; font-size: 12px; color: var(--text); margin-bottom: 8px;">Pre√ßo M√©dio Entrada</strong>
                    <div style="font-size: 22px; color: var(--primary); font-weight: bold;">$<span id="detailAvgEntry">-</span></div>
                </div>
                <div style="border-left: 4px solid var(--primary); padding-left: 15px;">
                    <strong style="display: block; font-size: 12px; color: var(--text); margin-bottom: 8px;">Pre√ßo M√©dio Sa√≠da</strong>
                    <div style="font-size: 22px; color: var(--primary); font-weight: bold;">$<span id="detailAvgExit">-</span></div>
                </div>
                <div style="border-left: 4px solid #4CAF50; padding-left: 15px;">
                    <strong style="display: block; font-size: 12px; color: var(--text); margin-bottom: 8px;">PnL Total</strong>
                    <div id="detailPnL" style="font-size: 22px; font-weight: bold;">-</div>
                </div>
            </div>
            <h3>üìà Opera√ß√µes do Trade</h3>
            <div style="display:flex; gap:12px; align-items:center; margin:8px 0 6px 0;">
                <div id="detailOpsSummary" style="font-size:12px; color:#9ca3af;">-</div>
                <a id="downloadOpsCSV" class="btn btn-secondary" href="#" download="trade-operations.csv">Baixar opera√ß√µes (CSV)</a>
            </div>
            <div style="overflow-x:auto;">
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th style="padding:10px; text-align:left; border-bottom:2px solid #ddd;">Hora</th>
                            <th style="padding:10px; text-align:left; border-bottom:2px solid #ddd;">A√ß√£o</th>
                            <th style="padding:10px; text-align:left; border-bottom:2px solid #ddd;">Quantidade</th>
                            <th style="padding:10px; text-align:left; border-bottom:2px solid #ddd;">Pre√ßo</th>
                            <th style="padding:10px; text-align:left; border-bottom:2px solid #ddd;">Comiss√£o</th>
                            <th style="padding:10px; text-align:left; border-bottom:2px solid #ddd;">Tipo</th>
                            <th style="padding:10px; text-align:left; border-bottom:2px solid #ddd;">ID</th>
                        </tr>
                    </thead>
                    <tbody id="detailOperations"></tbody>
                </table>
            </div>
        </div>
        <div id="tableScrollTop" class="scroll-top"><div id="tableScrollTopInner"></div></div>
        <div id="tableScrollBottom" class="scroll-bottom">
                <table id="tradesTable">
                <thead>
                    <tr>
                        <th role="columnheader" aria-label="Selecionar todos">
                            <input type="checkbox" id="selectAllHeader" aria-label="Selecionar todos os trades vis√≠veis">
                        </th>
                        <th role="columnheader" tabindex="0" data-key="status" aria-sort="none">Status <span class="sort">‚áÖ</span></th>
                        <th role="columnheader" tabindex="0" data-key="account" aria-sort="none">Conta <span class="sort">‚áÖ</span></th>
                        <th role="columnheader" tabindex="0" data-key="instrument" aria-sort="none">Instrumento <span class="sort">‚áÖ</span></th>
                        <th role="columnheader" tabindex="0" data-key="type" aria-sort="none">Tipo <span class="sort">‚áÖ</span></th>
                        <th role="columnheader" tabindex="0" data-key="avgEntry" aria-sort="none">Entrada <span class="sort">‚áÖ</span></th>
                        <th role="columnheader" tabindex="0" data-key="avgExit" aria-sort="none">Sa√≠da <span class="sort">‚áÖ</span></th>
                        <th role="columnheader" tabindex="0" data-key="pnlPoints" aria-sort="none">Pontos <span class="sort">‚áÖ</span></th>
                        <th role="columnheader" tabindex="0" data-key="pnlDollars" aria-sort="none">PnL $ <span class="sort">‚áÖ</span></th>
                        <th role="columnheader" tabindex="0" data-key="endTime" aria-sort="none">Fechamento <span class="sort">‚áÖ</span></th>
                        <th role="columnheader" tabindex="0" data-key="strategy" aria-sort="none">Estrat√©gia <span class="sort">‚áÖ</span></th>
                    </tr>
                </thead>
                <tbody id="tradesBody">
                    <tr><td colspan="11" class="loading">Nenhum trade</td></tr>
                </tbody>
            </table>
        </div>

        <div style="margin-top: 15px; background: var(--card-bg); padding: 15px; border-radius: 8px; display:flex; align-items:center; gap:10px; justify-content:space-between;">
            <label style="margin-right:8px;">Sele√ß√£o em massa:</label>
            <label style="margin-right:10px;"><input type="checkbox" id="selectAllTrades" onclick="toggleSelectAllTrades(this)"> Selecionar todos</label>
            <select id="bulkStrategySelect" style="padding:8px; border:1px solid #334155; border-radius:4px; background: var(--surface); color: var(--text);">
                <option value="">Selecione a estrat√©gia</option>
            </select>
            <button class="btn" style="background:#22d3ee; color:#0b1020; margin-left:10px;" onclick="applyStrategyBulk()">Aplicar</button>
            <div id="selectionCounter" aria-live="polite" style="margin-left:auto; font-size:12px; color:#9ca3af;">Selecionados: 0</div>
        </div>
        </div>
        </main>
    </div>
    <div id="modalBackdrop" class="modal-backdrop"></div>
    <div id="uploadModal" class="modal">
        <div class="modal-card">
            <div class="modal-header"><strong>üì§ Importar CSV</strong><button class="close-btn" onclick="closeUploadModal()">‚úï</button></div>
            <div>
                <div style="display:grid; grid-template-columns: 1fr; gap:10px; margin-bottom:10px;">
                    <label for="commissionPerContract" style="font-weight:600; display:flex; align-items:center; gap:8px;">
                        Valor da Comiss√£o por Contrato
                        <span title="Comiss√£o por opera√ß√£o = valor informado √ó quantidade de contratos" style="cursor:help; color:#9ca3af;">‚ùì</span>
                    </label>
                    <input id="commissionPerContract" type="text" inputmode="decimal" autocomplete="off" placeholder="0,00" aria-required="true" aria-invalid="false" style="padding:10px; border:2px solid #22d3ee; border-radius:6px; background:#0b1020; color:#e5e7eb;" oninput="maskMoney(this); validateCommission(this)" />
                    <div id="commissionError" style="display:none; color:#ef4444; font-size:12px;">Informe um valor num√©rico positivo</div>
                </div>
            </div>
            <div>
                <div style="display:grid; grid-template-columns: 1fr; gap:10px; margin-bottom:10px;">
                    <label for="commissionPerContract" style="font-weight:600; display:flex; align-items:center; gap:8px;">
                        Valor da Comiss√£o por Contrato
                        <span title="Comiss√£o por opera√ß√£o = valor informado √ó quantidade de contratos" style="cursor:help; color:#9ca3af;">‚ùì</span>
                    </label>
                    <input id="commissionPerContract" type="text" inputmode="decimal" autocomplete="off" placeholder="0,00" aria-required="true" aria-invalid="false" style="padding:10px; border:2px solid #22d3ee; border-radius:6px; background:#0b1020; color:#e5e7eb;" oninput="maskMoney(this); validateCommission(this)" />
                    <div id="commissionError" style="display:none; color:#ef4444; font-size:12px;">Informe um valor num√©rico positivo</div>
                </div>
                <input type="file" id="csvFileModal" accept=".csv" style="display:none" onchange="handleFileUpload(event)">
                <button class="btn btn-primary" onclick="document.getElementById('csvFileModal').click()">Selecionar arquivo CSV</button>
                <div id="uploadMessage" style="margin-top:8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUploadModal()">Fechar</button>
            </div>
        </div>
    </div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
    (function(){
        // handled in nav.js
    })();
    function openUploadModal(){ var m = document.getElementById('uploadModal'); var b = document.getElementById('modalBackdrop'); if (m && b) { m.classList.add('open'); b.classList.add('open'); } }
    function closeUploadModal(){ var m = document.getElementById('uploadModal'); var b = document.getElementById('modalBackdrop'); if (m && b) { m.classList.remove('open'); b.classList.remove('open'); } }
    (function(){
        var fp = flatpickr('#dateRangeInput', { mode: 'range', dateFormat: 'Y-m-d', onChange: function(sel){ if (!sel || sel.length < 2) return; var f = sel[0]; var t = sel[1]; var df = document.getElementById('dateFrom'); var dt = document.getElementById('dateTo'); var dp = document.getElementById('datePreset'); if (df && dt && dp) { dp.value = ''; df.value = fp.formatDate(f, 'Y-m-d'); dt.value = fp.formatDate(t, 'Y-m-d'); filterTrades(); } } });
        document.addEventListener('click', function(e){ var p = document.getElementById('datePanel'); if (!p) return; if (!p.contains(e.target) && !(e.target && e.target.closest('.dropdown'))) { p.classList.remove('open'); } });
    })();
    function toggleDatePanel(ev){ ev && ev.stopPropagation(); var p = document.getElementById('datePanel'); if (p) { p.classList.toggle('open'); } }
    function setPreset(p){ var dp = document.getElementById('datePreset'); var df = document.getElementById('dateFrom'); var dt = document.getElementById('dateTo'); if (dp && df && dt) { dp.value = p; df.value = ''; dt.value = ''; filterTrades(); } }
    function clearFilters(){ try { var af=document.getElementById('accountFilter'); var sf=document.getElementById('strategyFilter'); var inf=document.getElementById('instrumentFilter'); var dp=document.getElementById('datePreset'); var df=document.getElementById('dateFrom'); var dt=document.getElementById('dateTo'); var dri=document.getElementById('dateRangeInput'); if(af) af.value=''; if(sf) sf.value=''; if(inf) inf.value=''; if(dp) dp.value=''; if(df) df.value=''; if(dt) dt.value=''; if(dri) dri.value=''; } catch(e){} filterTrades(); }
    function maskMoney(el){ try { var v = String(el.value || '').replace(/[^0-9]/g,''); if (v.length === 0) { el.value = ''; return; } var int = v.slice(0, -2); var dec = v.slice(-2); if (int.length === 0) int = '0'; var intFmt = int.replace(/\B(?=(\d{3})+(?!\d))/g, '.'); el.value = intFmt + ',' + dec; } catch(e){} }
    function parseMoney(el){ var s = String(el && el.value || '').trim(); if (!s) return NaN; return parseFloat(s.replace(/\./g,'').replace(',', '.')); }
    function validateCommission(el){ var v = parseMoney(el); var err = document.getElementById('commissionError'); var invalid = isNaN(v) || v < 0; if (err) err.style.display = invalid ? 'block' : 'none'; el.setAttribute('aria-invalid', invalid ? 'true' : 'false'); }
    function maskMoney(el){ try { var v = String(el.value || '').replace(/[^0-9]/g,''); if (v.length === 0) { el.value = ''; return; } var int = v.slice(0, -2); var dec = v.slice(-2); if (int.length === 0) int = '0'; var intFmt = int.replace(/\B(?=(\d{3})+(?!\d))/g, '.'); el.value = intFmt + ',' + dec; } catch(e){} }
    function parseMoney(el){ var s = String(el && el.value || '').trim(); if (!s) return NaN; return parseFloat(s.replace(/\./g,'').replace(',', '.')); }
    function validateCommission(el){ var v = parseMoney(el); var err = document.getElementById('commissionError'); var invalid = isNaN(v) || v < 0; if (err) err.style.display = invalid ? 'block' : 'none'; el.setAttribute('aria-invalid', invalid ? 'true' : 'false'); }
    function updateStickyOffsets(){ try { var h = document.querySelector('.app-header'); var d = document.getElementById('tradeDetails'); var hh = h ? h.offsetHeight : 0; var dv = (d && d.style.display !== 'none') ? d.offsetHeight : 0; document.documentElement.style.setProperty('--sticky-details-top', hh + 'px'); document.documentElement.style.setProperty('--sticky-table-top', (hh + dv) + 'px'); } catch(e){} }
    window.addEventListener('load', updateStickyOffsets);
    window.addEventListener('resize', updateStickyOffsets);
    (function(){ var d = document.getElementById('tradeDetails'); if (d) { var mo = new MutationObserver(updateStickyOffsets); mo.observe(d, { attributes: true, attributeFilter: ['style','class'] }); } })();
    </script>
    <script src="globals.js"></script>
    <script src="supabase-init.js"></script>
    <script src="theme.js"></script>
    <script src="nav.js"></script>
    <script src="operations.js"></script>
    <script src="strategies.js"></script>
    <script src="trades.js"></script>
    <script src="maintenance.js"></script>
    <script src="table.js"></script>
    <script src="main.js"></script>
</body>
</html>
